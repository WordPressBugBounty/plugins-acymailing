jQuery(function(){!function e(t){Vue.use(infiniteScroll);let i=0,s=[],l=[],a=0;const n={available:20,selected:20};let c;const o=(e,t,i)=>(t=t.toLowerCase(),e.filter(e=>i.map(function(i){return null!==e[i]&&("number"==typeof e[i]?e[i].toString().toLowerCase().includes(t):e[i].toLowerCase().includes(t))}).includes(!0))),h=(e,t)=>e.filter(e=>e.id!==t),r=(e,t)=>e.filter(e=>e.id===t),d=e=>e.map(e=>parseInt(e.id));null!==document.getElementById("acym__entity_select")&&new Vue({directives:{infiniteScroll:infiniteScroll},el:"#acym__entity_select",data:{tableJoin:"",entitiesUnselected:[],data:{},columnJoin:"",offsetBase:5e3,entity:"",displaySelected:!0,loading:!0,entitiesToDisplay_available:[],columnsToDisplay:[],entitiesToDisplay_selected:[],entitiesAvailable:[],entitiesSelected:[],join:"",busy:!1,availableSearch:"",selectedSearch:"",displaySelectAll_available:!0,displaySelectAll_selected:!0,columnsClasses:[]},mounted:function(){let i=document.getElementById("acym__entity_select");i.style.display="flex",this.entity=i.getAttribute("data-entity"),this.columnsToDisplay=i.getAttribute("data-columns").split(","),this.columnsClasses=acym_helper.parseJson(i.getAttribute("data-columns-class")),this.join=i.getAttribute("data-join"),this.displaySelected="true"===i.getAttribute("data-display-selected"),this.columnJoin=i.getAttribute("data-column-join"),this.tableJoin=i.getAttribute("data-table-join"),this.getAllEntities(this.entity),t(window).off("refreshEntitySelect").on("refreshEntitySelect",function(){e(t)}),setTimeout(()=>{acym_helperTooltip.setTooltip()},400),t("#acym__lists__settings__subscribers__entity__modal").off("open.zf.reveal").on("open.zf.reveal",function(){acym_helperTooltip.setUserInfoLoadingHover()})},methods:{getClass(e){return"string"==typeof this.columnsClasses[e]?this.columnsClasses[e]:"auto"},selectEntity(e){let t=r(this.entitiesToDisplay_available,e)[0];this.entitiesToDisplay_selected.push(t),this.entitiesSelected.push(t),this.entitiesToDisplay_available=h(this.entitiesToDisplay_available,e),this.entitiesAvailable=h(this.entitiesAvailable,e),this.entitiesUnselected=h(this.entitiesUnselected,e),this.doSearch("selected",0)},unselectEntity(e){let t=r(this.entitiesToDisplay_selected,e)[0];this.entitiesToDisplay_available.push(t),this.entitiesUnselected.push(t),this.entitiesAvailable.push(t),this.entitiesToDisplay_selected=h(this.entitiesToDisplay_selected,e),this.entitiesSelected=h(this.entitiesSelected,e),this.doSearch("available",0)},loadMoreEntity(e){n[e]+=20;let t="entitiesToDisplay_"+e,i="entities"+e.charAt(0).toUpperCase()+e.slice(1);this[t]=""===this[e+"Search"]?this[i].slice(0,n[e]):o(this["entities"+e.charAt(0).toUpperCase()+e.slice(1)],this[e+"Search"],this.columnsToDisplay)},loadMoreEntityAvailable(){this.loadMoreEntity("available")},loadMoreEntitySelected(){this.loadMoreEntity("selected")},moveAll(e){"available"===e?(this.entitiesSelected=this.entitiesSelected.concat(this.entitiesAvailable),this.entitiesAvailable=[],this.entitiesToDisplay_available=[],this.entitiesToDisplay_selected=this.entitiesSelected.slice(0,n.selected),this.doSearch("selected",0)):(this.entitiesAvailable=this.entitiesAvailable.concat(this.entitiesSelected),this.entitiesUnselected=this.entitiesUnselected.concat(this.entitiesSelected),this.entitiesSelected=[],this.entitiesToDisplay_available=this.entitiesAvailable.slice(0,n.available),this.entitiesToDisplay_selected=[],this.doSearch("available",0))},doSearch(e,t=1e3){clearTimeout(c),c=setTimeout(()=>{""===this[e+"Search"]?(this["displaySelectAll_"+e]=!0,n[e]=20,this["entitiesToDisplay_"+e]=this["entities"+e.charAt(0).toUpperCase()+e.slice(1)].slice(0,n[e])):(this["displaySelectAll_"+e]=!1,this["entitiesToDisplay_"+e]=o(this["entities"+e.charAt(0).toUpperCase()+e.slice(1)],this[e+"Search"],this.columnsToDisplay))},t)},handleEntities(e){s=s.concat(e);let t=[];null!==this.columnJoin&&(t=((e,t)=>e.filter(e=>null!==e[t]))(e,this.columnJoin),l=l.concat(t)),this.entitiesAvailable=this.entitiesAvailable.concat(((e,t)=>e.filter(e=>-1===JSON.stringify(t).indexOf(JSON.stringify(e))))(e,t)),this.entitiesToDisplay_available.length<1&&(this.entitiesToDisplay_available=this.entitiesAvailable.slice(0,n.available)),this.displaySelected&&null!==this.columnJoin&&(this.entitiesSelected=this.entitiesSelected.concat(t),this.entitiesToDisplay_selected.length<1&&(this.entitiesToDisplay_selected=this.entitiesSelected.slice(0,n.selected)))},getAllEntities(e){let s="";acym_helper.empty(this.tableJoin)||acym_helper.empty(this.columnJoin)||(s="&join_table="+this.tableJoin+"."+this.columnJoin);let l=ACYM_IS_ADMIN?"entitySelect":"frontentityselect",n=ACYM_AJAX_URL;n+="&ctrl="+l,n+="&task=loadEntityFront",n+="&offset="+i,n+="&perCalls=500",n+="&entity="+e,n+="&join="+this.join,n+="&columns="+this.columnsToDisplay.join(",")+s,t.get(n,t=>!(!(t=acym_helper.parseJson(t))||(t.error?(console.log(t.error),1):"end"===t.data.results.data?(this.loading=!1,0):(a=t.data.results.data.total.total,this.handleEntities(t.data.results.data.elements),i>a?(this.loading=!1,0):(i+=500,this.getAllEntities(e),0)))))},finalLoad(){this.loading=!1,this.loadMoreEntity("available"),this.loadMoreEntity("selected"),t("#acym__entity_select__button__submit.acy_button_submit").length&&acym_helper.setSubmitButtonGlobal(),t(".acym__entity_select__button__close").off("click").on("click",function(){t(this).closest(".reveal").foundation("close")}),acym_helperImport.setVerificationGenericImport(),acym_helperImport.setImportCMSLists(),acym_helperImport.setCreateListFromImportPage()}},watch:{availableSearch:function(){this.doSearch("available")},selectedSearch:function(){this.doSearch("selected")},entitiesSelected(){let e=d(this.entitiesSelected);document.querySelector('[name="acym__entity_select__selected"]').value=JSON.stringify(e);let i=document.querySelector(".entity_select__recipients__number-recipients");void 0!==i&&null!=i&&function(e){const i=t('[name="page"]'),s={listsSelected:e,page:i.length>0?i.val():"acymailing_campaigns",ctrl:t('[name="ctrl"]').val(),task:"ajaxCountNumberOfRecipients"};t.ajax({url:ACYM_AJAX_URL,type:"POST",data:s,beforeSend:function(){t(".entity_select__recipients__number-recipients, #entity_select__recipients__span").hide(),t(".acym_loader_logo").show()}}).done(function(e){const i=acym_helper.parseJson(e);t(".entity_select__recipients__number-recipients").html(i.data.recipients).show(),t("#entity_select__recipients__span").show(),t(".acym_loader_logo").hide()}).fail(function(){t(".entity_select__recipients__number-recipients").html(0)})}(e)},entitiesUnselected(){document.querySelector('[name="acym__entity_select__unselected"]').value=JSON.stringify(d(this.entitiesUnselected))},loading(e){e||this.finalLoad()}}})}(jQuery)});